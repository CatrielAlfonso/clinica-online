<div class="contenedor-registro">
    <!-- SPINNER -->
    <div *ngIf="cargandoDatos" class="spinner-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">-</span>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="registro mat-elevation-z8" *ngIf="!cargandoDatos">
        <h1 *ngIf="userService.rolUsuarioLogueado == 'Paciente'">Solicitud de turnos</h1>
        <h1 *ngIf="userService.rolUsuarioLogueado == 'Administrador'">Asignación de turnos</h1>
        
        <!-- ==================== FORMULARIO PACIENTE ==================== -->
        <form [formGroup]="formPaciente" *ngIf="userService.rolUsuarioLogueado == 'Paciente'" (ngSubmit)="SolicitarTurno()">
            
            <!-- PASO 1: SELECCIONAR ESPECIALISTA -->
            <div class="seccion-seleccion">
                <h4>1️⃣ Seleccione un profesional</h4>
                <div class="grid-especialistas">
                    <button type="button" 
                            class="btn-especialista-cuadrado"
                            [class.seleccionado]="especialistaSeleccionado?.dni === especialista.dni"
                            *ngFor="let especialista of especialistasDisponibles"
                            (click)="SeleccionarEspecialista(especialista)"
                            appAgrandarOnHover
                            appResaltarOnHover>
                        <img [src]="especialista.imagen1" [alt]="especialista.nombre" class="img-especialista">
                        <p class="nombre-especialista">{{especialista.nombre | acortarNombre}} {{especialista.apellido}}</p>
                    </button>
                </div>
            </div>

            <!-- PASO 2: SELECCIONAR ESPECIALIDAD -->
            <div class="seccion-seleccion" *ngIf="especialistaSeleccionado">
                <h4>2️⃣ Seleccione una especialidad</h4>
                <div class="grid-especialidades">
                    <button type="button"
                            class="btn-especialidad-rectangular"
                            [class.seleccionado]="especialidadSeleccionada === especialidad"
                            *ngFor="let especialidad of especialidadesDelEspecialista"
                            (click)="SeleccionarEspecialidad(especialidad)"
                            appAgrandarOnHover
                            appResaltarOnHover>
                        <img [src]="ObtenerImagenEspecialidad(especialidad)" [alt]="especialidad" class="img-especialidad">
                        <p class="nombre-especialidad">{{especialidad}}</p>
                    </button>
                </div>
            </div>

            <!-- PASO 3: SELECCIONAR TURNO -->
            <div class="seccion-seleccion" *ngIf="especialidadSeleccionada">
                <h4>3️⃣ Seleccione un turno disponible</h4>
                <div class="grid-turnos">
                    <button type="button"
                            class="btn-turno-cuadrado"
                            [class.seleccionado]="turnoSeleccionado === turno"
                            *ngFor="let turno of turnosDisponibles"
                            (click)="SeleccionarTurno(turno)"
                            appAgrandarOnHover
                            appResaltarOnHover>
                        {{turno}}
                    </button>
                </div>
                <p *ngIf="turnosDisponibles.length === 0" class="text-muted">No hay turnos disponibles</p>
            </div>

            <hr class="my-4">
            <button class="w-100 btn btn-primary btn-lg" type="submit" [disabled]="formPaciente.invalid">
                Solicitar turno
            </button>
        </form>

        <!-- ==================== FORMULARIO ADMINISTRADOR ==================== -->
        <form [formGroup]="formAdministrador" *ngIf="userService.rolUsuarioLogueado == 'Administrador'" (ngSubmit)="SolicitarTurno()">
            
            <!-- PASO 1: SELECCIONAR ESPECIALISTA -->
            <div class="seccion-seleccion">
                <h4>1️⃣ Seleccione un profesional</h4>
                <div class="grid-especialistas">
                    <button type="button" 
                            class="btn-especialista-cuadrado"
                            [class.seleccionado]="especialistaSeleccionado?.dni === especialista.dni"
                            *ngFor="let especialista of especialistasDisponibles"
                            (click)="SeleccionarEspecialista(especialista)"
                            appAgrandarOnHover
                            appResaltarOnHover>
                        <img [src]="especialista.imagen1" [alt]="especialista.nombre" class="img-especialista">
                        <p class="nombre-especialista">{{especialista.nombre | acortarNombre}} {{especialista.apellido}}</p>
                    </button>
                </div>
            </div>

            <!-- PASO 2: SELECCIONAR ESPECIALIDAD -->
            <div class="seccion-seleccion" *ngIf="especialistaSeleccionado">
                <h4>2️⃣ Seleccione una especialidad</h4>
                <div class="grid-especialidades">
                    <button type="button"
                            class="btn-especialidad-rectangular"
                            [class.seleccionado]="especialidadSeleccionada === especialidad"
                            *ngFor="let especialidad of especialidadesDelEspecialista"
                            (click)="SeleccionarEspecialidad(especialidad)"
                            appAgrandarOnHover
                            appResaltarOnHover>
                        <img [src]="ObtenerImagenEspecialidad(especialidad)" [alt]="especialidad" class="img-especialidad">
                        <p class="nombre-especialidad">{{especialidad}}</p>
                    </button>
                </div>
            </div>

            <!-- PASO 3: SELECCIONAR PACIENTE -->
            <div class="seccion-seleccion" *ngIf="especialidadSeleccionada">
                <h4>3️⃣ Asigne un paciente</h4>
                <div class="tabla-pacientes">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Apellido</th>
                                <th>DNI</th>
                                <th>Edad</th>
                                <th>Imagen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let paciente of pacientesObtenidos" 
                                (click)="AsignarPaciente(paciente)"
                                [class.table-active]="pacienteSeleccionado?.dni === paciente.dni"
                                style="cursor: pointer;">
                                <td>{{paciente.nombre | acortarNombre}}</td>
                                <td>{{paciente.apellido}}</td>
                                <td>{{paciente.dni | formatearDni}}</td>
                                <td>{{paciente.edad}}</td>
                                <td><img [src]="paciente.imagen1" height="48px"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PASO 4: SELECCIONAR TURNO -->
            <div class="seccion-seleccion" *ngIf="pacienteSeleccionado">
                <h4>4️⃣ Seleccione un turno disponible</h4>
                <div class="grid-turnos">
                    <button type="button"
                            class="btn-turno-cuadrado"
                            [class.seleccionado]="turnoSeleccionado === turno"
                            *ngFor="let turno of turnosDisponibles"
                            (click)="SeleccionarTurno(turno)"
                            appAgrandarOnHover
                            appResaltarOnHover>
                        {{turno}}
                    </button>
                </div>
                <p *ngIf="turnosDisponibles.length === 0" class="text-muted">No hay turnos disponibles</p>
            </div>

            <hr class="my-4">
            <button class="w-100 btn btn-primary btn-lg" type="submit" [disabled]="formAdministrador.invalid">
                Asignar turno
            </button>
        </form>
    </div>
</div>